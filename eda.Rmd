---
title: "Alelos HLA em câncer de bexiga"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	comment = ""
)
```

```{r}
library(tidyverse)
library(rvest)
```


## Alelos dos pacientes

```{r}
# ler com read.table ao invés de read_tsv
# porque o arquivo tem inconsistências com o separador nas últimas linhas
# espaços em número variável ao invés de tabs
hlatypes <- read.table("./hlatypes.txt", header = TRUE) %>%
    as_tibble() %>%
    pivot_longer(-1, names_to = "locus", values_to = "allele") %>%
    mutate(locus = sub("^(HLA)\\.([ABC])_\\d$", "\\1-\\2", locus),
           allele = toupper(allele),
           allele = sub("^HLA_([^_]+)_(\\d+)_(\\d+)$", "\\1*\\2:\\3", allele),
           allele = recode(allele, "A*07:07" = "A*02:07")) #fix typo

hlatypes
```


## Busca dos alelos nos bancos do NetMHC e NetMHCpan

Vamos comparar os alelos dos pacientes com aqueles presentes nos bancos do NetMHC e NetMHCpan:

```{r}
netmhc <- 
    "https://services.healthtech.dtu.dk/services/NetMHC-4.0/MHC_allele_names.txt" %>%
    read_tsv(col_names = FALSE) %>%
    setNames(c("id", "allele", "locus")) %>%
    select(locus, allele) %>%
    mutate(allele = sub("^HLA-", "", allele))

netmhcpan <- 
    "https://services.healthtech.dtu.dk/services/NetMHCpan-4.1/MHC_allele_names.txt" %>%
    read_tsv(col_names = FALSE) %>%
    setNames("allele") %>%
    mutate(allele = sub("^HLA-([A-Z]+)(.+)$", "\\1*\\2", allele))
   
hlatypes %>%
    drop_na() %>%
    mutate(NetMHC = allele %in% netmhc$allele,
           NetMHCpan = allele %in% netmhcpan$allele) %>%
    summarise_at(vars(4:5), mean) %>%
    pivot_longer(1:2, names_to = "database", values_to = "percent") %>%
    mutate(percent = scales::percent(percent)) %>%
    knitr::kable()

```

Vemos que 65% dos alelos são encontrados no NetMHC, mas todos os alelos são encontrados no NetMHCpan v4.1.


## Busca no allelefrequencies.net para obter a frequência alélica

Vamos buscar esses alelos no Allelefrequencies.net para ver sua frequência na população chinesa.

Para isso criei a função abaixo:

```{r}
get_frequency <- function(allele) {
    
    hlaurl <- 
        "http://www.allelefrequencies.net/hla6006a.asp?hla_selection=%s&hla_country=China"

    hlahtml <- hlaurl %>%
	    sprintf(sub("HLA-", "", allele)) %>%
	    read_html()

    nodes <- html_nodes(hlahtml, "table")

    if (grepl("Sorry, we did not find any results", nodes[[4]]))
	return(NA)

    nodes[[5]] %>%
	    html_table(fill = TRUE, header = TRUE) %>%
	    select(2, 4, 6, 8) %>%
	    as_tibble() %>%
	    setNames(c("allele_db", "population", "f", "sample_size")) %>%
	    mutate(sample_size = as.integer(sub(",", "", sample_size)))
}
```

Ela tem o seguinte output quando aplicada a um alelo:

```{r}
get_frequency("A*01:01")
```

Vamos aplicar a todos os alelos dos pacientes. Como são várias amostragens na China, vou tirar uma média ponderada da frequência alélica dados os tamanhos amostrais.

Aplicar a todos os alelos pode levar alguns minutos, então vou paralelizar com `furrr`.

```{r}
library(furrr)

plan(multisession, workers = 8)

allele_freqs <- hlatypes %>% 
    drop_na() %>%
    distinct(locus, allele) %>%
    mutate(data = future_map(allele, get_frequency)) %>%
    unnest(data) %>%
    group_by(locus, allele) %>%
    summarise(wf = weighted.mean(f, sample_size)) %>%
    ungroup()

allele_freqs
```

Verificamos quais alelos não estão no banco do allelefrequencies.net:

```{r}
allele_freqs %>% 
    filter(is.na(wf)) %>%
    pull(allele)
```

Para esse alelo, ainda podemos buscar no banco de alelos raros.

Para isso, vou precisar criar uma função similar à anterior:

```{r}
get_rare <- function(allele) {

    hlaurl <- "http://www.allelefrequencies.net/hla6002a.asp?all_name=%s"

    hlahtml <- hlaurl %>%
	sprintf(sub("HLA-", "", allele)) %>%
	read_html()

    nodes <- html_nodes(hlahtml, "table")

    nodes[[4]] %>%
	html_table(fill = TRUE, header = TRUE) %>%
	select(2, 4, 6) %>%
	as_tibble() %>%
	setNames(c("population", "f", "sample_size"))
}
```

Aplico essa função aos alelos:

```{r}
get_rare("A*02:133") %>%
    filter(f > 0) %>%
    knitr::kable(format.args = list(scientific = FALSE))
```

Vemos que o `A*02:133` não foi descrito na China (nesse banco de dados), apenas possui uma frequência muita baixa numa outra população.

No entanto, para os outros alelos, podemos plotar a frequência:

```{r, fig.width=8, fig.height=6}
allele_freqs %>%
    mutate(allele = fct_reorder(allele, -wf)) %>%
    ggplot(aes(x = wf, y = allele, fill = wf)) +
    geom_col() +
    scale_y_discrete(limits = rev) +
    facet_wrap(~locus, scales = "free", nrow = 1) +
    scale_fill_continuous(type = "viridis",
                          guide = guide_colourbar(direction = "horizontal",
                                                  barwidth = 10,
                                                   barheight = .5)) +
    labs(x = "Allele frequency in China", y = NULL, fill = NULL) +
    theme_bw() +
    theme(legend.position = "bottom")
```
